begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|cli
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|OutputStreamWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|Writer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Field
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|ServerSocket
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|Socket
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URI
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|URL
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|NumberFormat
import|;
end_import

begin_import
import|import
name|java
operator|.
name|text
operator|.
name|ParsePosition
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Comparator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|OutputKeys
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|TransformerConfigurationException
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|sax
operator|.
name|SAXTransformerFactory
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|sax
operator|.
name|TransformerHandler
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|xml
operator|.
name|transform
operator|.
name|stream
operator|.
name|StreamResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|BasicConfigurator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Level
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|SimpleLayout
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|log4j
operator|.
name|WriterAppender
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|config
operator|.
name|TikaConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|detect
operator|.
name|DefaultDetector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|detect
operator|.
name|Detector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|extractor
operator|.
name|EmbeddedDocumentExtractor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|fork
operator|.
name|ForkParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|gui
operator|.
name|TikaGUI
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|io
operator|.
name|CloseShieldInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|io
operator|.
name|TikaInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|language
operator|.
name|LanguageProfilerBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|language
operator|.
name|ProfilingHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|metadata
operator|.
name|Metadata
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|mime
operator|.
name|MediaType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|mime
operator|.
name|MediaTypeRegistry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|mime
operator|.
name|MimeTypeException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|AutoDetectParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|CompositeParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|NetworkParser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|ParseContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|Parser
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|ParserDecorator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|parser
operator|.
name|html
operator|.
name|BoilerpipeContentHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tika
operator|.
name|sax
operator|.
name|BodyContentHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|ContentHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|SAXException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|xml
operator|.
name|sax
operator|.
name|helpers
operator|.
name|DefaultHandler
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|gson
operator|.
name|Gson
import|;
end_import

begin_comment
comment|/**  * Simple command line interface for Apache Tika.  */
end_comment

begin_class
specifier|public
class|class
name|TikaCLI
block|{
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
throws|throws
name|Exception
block|{
name|BasicConfigurator
operator|.
name|configure
argument_list|(
operator|new
name|WriterAppender
argument_list|(
operator|new
name|SimpleLayout
argument_list|()
argument_list|,
name|System
operator|.
name|err
argument_list|)
argument_list|)
expr_stmt|;
name|Logger
operator|.
name|getRootLogger
argument_list|()
operator|.
name|setLevel
argument_list|(
name|Level
operator|.
name|INFO
argument_list|)
expr_stmt|;
name|TikaCLI
name|cli
init|=
operator|new
name|TikaCLI
argument_list|()
decl_stmt|;
if|if
condition|(
name|args
operator|.
name|length
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|args
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|cli
operator|.
name|process
argument_list|(
name|args
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cli
operator|.
name|pipeMode
condition|)
block|{
name|cli
operator|.
name|process
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// Started with no arguments. Wait for up to 0.1s to see if
comment|// we have something waiting in standard input and use the
comment|// pipe mode if we have. If no input is seen, start the GUI.
if|if
condition|(
name|System
operator|.
name|in
operator|.
name|available
argument_list|()
operator|==
literal|0
condition|)
block|{
name|Thread
operator|.
name|sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|System
operator|.
name|in
operator|.
name|available
argument_list|()
operator|>
literal|0
condition|)
block|{
name|cli
operator|.
name|process
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cli
operator|.
name|process
argument_list|(
literal|"--gui"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
class|class
name|OutputType
block|{
specifier|public
name|void
name|process
parameter_list|(
name|InputStream
name|input
parameter_list|,
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
name|Parser
name|p
init|=
name|parser
decl_stmt|;
if|if
condition|(
name|fork
condition|)
block|{
name|p
operator|=
operator|new
name|ForkParser
argument_list|(
name|TikaCLI
operator|.
name|class
operator|.
name|getClassLoader
argument_list|()
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
name|ContentHandler
name|handler
init|=
name|getContentHandler
argument_list|(
name|output
argument_list|)
decl_stmt|;
name|p
operator|.
name|parse
argument_list|(
name|input
argument_list|,
name|handler
argument_list|,
name|metadata
argument_list|,
name|context
argument_list|)
expr_stmt|;
comment|// fix for TIKA-596: if a parser doesn't generate
comment|// XHTML output, the lack of an output document prevents
comment|// metadata from being output: this fixes that
if|if
condition|(
name|handler
operator|instanceof
name|NoDocumentMetHandler
condition|)
block|{
name|NoDocumentMetHandler
name|metHandler
init|=
operator|(
name|NoDocumentMetHandler
operator|)
name|handler
decl_stmt|;
if|if
condition|(
operator|!
name|metHandler
operator|.
name|metOutput
argument_list|()
condition|)
block|{
name|metHandler
operator|.
name|endDocument
argument_list|()
expr_stmt|;
block|}
block|}
block|}
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
throw|throw
operator|new
name|UnsupportedOperationException
argument_list|()
throw|;
block|}
block|}
specifier|private
specifier|final
name|OutputType
name|XML
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|getTransformerHandler
argument_list|(
name|output
argument_list|,
literal|"xml"
argument_list|,
name|encoding
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|HTML
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
return|return
name|getTransformerHandler
argument_list|(
name|output
argument_list|,
literal|"html"
argument_list|,
name|encoding
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|TEXT
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
return|return
operator|new
name|BodyContentHandler
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|NO_OUTPUT
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
block|{
return|return
operator|new
name|DefaultHandler
argument_list|()
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|TEXT_MAIN
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
return|return
operator|new
name|BoilerpipeContentHandler
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|METADATA
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
specifier|final
name|PrintWriter
name|writer
init|=
operator|new
name|PrintWriter
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|new
name|NoDocumentMetHandler
argument_list|(
name|writer
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|JSON
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
specifier|final
name|PrintWriter
name|writer
init|=
operator|new
name|PrintWriter
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|new
name|NoDocumentJSONMetHandler
argument_list|(
name|writer
argument_list|)
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|LANGUAGE
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|protected
name|ContentHandler
name|getContentHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
specifier|final
name|PrintWriter
name|writer
init|=
operator|new
name|PrintWriter
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
decl_stmt|;
return|return
operator|new
name|ProfilingHandler
argument_list|()
block|{
specifier|public
name|void
name|endDocument
parameter_list|()
block|{
name|writer
operator|.
name|println
argument_list|(
name|getLanguage
argument_list|()
operator|.
name|getLanguage
argument_list|()
argument_list|)
expr_stmt|;
name|writer
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
return|;
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|OutputType
name|DETECT
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|process
parameter_list|(
name|InputStream
name|stream
parameter_list|,
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
name|PrintWriter
name|writer
init|=
operator|new
name|PrintWriter
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
decl_stmt|;
name|writer
operator|.
name|println
argument_list|(
name|detector
operator|.
name|detect
argument_list|(
name|stream
argument_list|,
name|metadata
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|writer
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
decl_stmt|;
comment|/* Creates ngram profile */
specifier|private
specifier|final
name|OutputType
name|CREATE_PROFILE
init|=
operator|new
name|OutputType
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|process
parameter_list|(
name|InputStream
name|stream
parameter_list|,
name|OutputStream
name|output
parameter_list|)
throws|throws
name|Exception
block|{
name|ngp
operator|=
name|LanguageProfilerBuilder
operator|.
name|create
argument_list|(
name|profileName
argument_list|,
name|stream
argument_list|,
name|encoding
argument_list|)
expr_stmt|;
name|FileOutputStream
name|fos
init|=
operator|new
name|FileOutputStream
argument_list|(
operator|new
name|File
argument_list|(
name|profileName
operator|+
literal|".ngp"
argument_list|)
argument_list|)
decl_stmt|;
name|ngp
operator|.
name|save
argument_list|(
name|fos
argument_list|)
expr_stmt|;
comment|//saves ngram profile
name|fos
operator|.
name|close
argument_list|()
expr_stmt|;
name|PrintWriter
name|writer
init|=
operator|new
name|PrintWriter
argument_list|(
name|getOutputWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
argument_list|)
decl_stmt|;
name|writer
operator|.
name|println
argument_list|(
literal|"ngram profile location:="
operator|+
operator|new
name|File
argument_list|(
name|ngp
operator|.
name|getName
argument_list|()
argument_list|)
operator|.
name|getCanonicalPath
argument_list|()
argument_list|)
expr_stmt|;
name|writer
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
decl_stmt|;
specifier|private
name|ParseContext
name|context
decl_stmt|;
specifier|private
name|Detector
name|detector
decl_stmt|;
specifier|private
name|Parser
name|parser
decl_stmt|;
specifier|private
name|Metadata
name|metadata
decl_stmt|;
specifier|private
name|OutputType
name|type
init|=
name|XML
decl_stmt|;
specifier|private
name|LanguageProfilerBuilder
name|ngp
init|=
literal|null
decl_stmt|;
comment|/**      * Output character encoding, or<code>null</code> for platform default      */
specifier|private
name|String
name|encoding
init|=
literal|null
decl_stmt|;
specifier|private
name|boolean
name|pipeMode
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|serverMode
init|=
literal|false
decl_stmt|;
specifier|private
name|boolean
name|fork
init|=
literal|false
decl_stmt|;
specifier|private
name|String
name|profileName
init|=
literal|null
decl_stmt|;
specifier|public
name|TikaCLI
parameter_list|()
throws|throws
name|Exception
block|{
name|context
operator|=
operator|new
name|ParseContext
argument_list|()
expr_stmt|;
name|detector
operator|=
operator|new
name|DefaultDetector
argument_list|()
expr_stmt|;
name|parser
operator|=
operator|new
name|AutoDetectParser
argument_list|(
name|detector
argument_list|)
expr_stmt|;
name|context
operator|.
name|set
argument_list|(
name|Parser
operator|.
name|class
argument_list|,
name|parser
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|process
parameter_list|(
name|String
name|arg
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-?"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--help"
argument_list|)
condition|)
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|usage
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-v"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--verbose"
argument_list|)
condition|)
block|{
name|Logger
operator|.
name|getRootLogger
argument_list|()
operator|.
name|setLevel
argument_list|(
name|Level
operator|.
name|DEBUG
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-g"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--gui"
argument_list|)
condition|)
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|TikaGUI
operator|.
name|main
argument_list|(
operator|new
name|String
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"--list-parser"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--list-parsers"
argument_list|)
condition|)
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|displayParsers
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"--list-parser-detail"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--list-parser-details"
argument_list|)
condition|)
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|displayParsers
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"--list-met-models"
argument_list|)
condition|)
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|displayMetModels
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"--list-supported-types"
argument_list|)
condition|)
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|displaySupportedTypes
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"--container-aware"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--container-aware-detector"
argument_list|)
condition|)
block|{
comment|// ignore, as container-aware detectors are now always used
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-f"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--fork"
argument_list|)
condition|)
block|{
name|fork
operator|=
literal|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|startsWith
argument_list|(
literal|"-e"
argument_list|)
condition|)
block|{
name|encoding
operator|=
name|arg
operator|.
name|substring
argument_list|(
literal|"-e"
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|startsWith
argument_list|(
literal|"--encoding="
argument_list|)
condition|)
block|{
name|encoding
operator|=
name|arg
operator|.
name|substring
argument_list|(
literal|"--encoding="
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-j"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--json"
argument_list|)
condition|)
block|{
name|type
operator|=
name|JSON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-x"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--xml"
argument_list|)
condition|)
block|{
name|type
operator|=
name|XML
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-h"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--html"
argument_list|)
condition|)
block|{
name|type
operator|=
name|HTML
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-t"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--text"
argument_list|)
condition|)
block|{
name|type
operator|=
name|TEXT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-T"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--text-main"
argument_list|)
condition|)
block|{
name|type
operator|=
name|TEXT_MAIN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-m"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--metadata"
argument_list|)
condition|)
block|{
name|type
operator|=
name|METADATA
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-l"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--language"
argument_list|)
condition|)
block|{
name|type
operator|=
name|LANGUAGE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-d"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--detect"
argument_list|)
condition|)
block|{
name|type
operator|=
name|DETECT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-z"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--extract"
argument_list|)
condition|)
block|{
name|type
operator|=
name|NO_OUTPUT
expr_stmt|;
name|context
operator|.
name|set
argument_list|(
name|EmbeddedDocumentExtractor
operator|.
name|class
argument_list|,
operator|new
name|FileEmbeddedDocumentExtractor
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-p"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--port"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"-s"
argument_list|)
operator|||
name|arg
operator|.
name|equals
argument_list|(
literal|"--server"
argument_list|)
condition|)
block|{
name|serverMode
operator|=
literal|true
expr_stmt|;
name|pipeMode
operator|=
literal|false
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|startsWith
argument_list|(
literal|"-c"
argument_list|)
condition|)
block|{
name|URI
name|uri
init|=
operator|new
name|URI
argument_list|(
name|arg
operator|.
name|substring
argument_list|(
literal|"-c"
operator|.
name|length
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|parser
operator|=
operator|new
name|NetworkParser
argument_list|(
name|uri
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|startsWith
argument_list|(
literal|"--client="
argument_list|)
condition|)
block|{
name|URI
name|uri
init|=
operator|new
name|URI
argument_list|(
name|arg
operator|.
name|substring
argument_list|(
literal|"--client="
operator|.
name|length
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
name|parser
operator|=
operator|new
name|NetworkParser
argument_list|(
name|uri
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|startsWith
argument_list|(
literal|"--create-profile="
argument_list|)
condition|)
block|{
name|profileName
operator|=
name|arg
operator|.
name|substring
argument_list|(
literal|"--create-profile="
operator|.
name|length
argument_list|()
argument_list|)
expr_stmt|;
name|type
operator|=
name|CREATE_PROFILE
expr_stmt|;
block|}
else|else
block|{
name|pipeMode
operator|=
literal|false
expr_stmt|;
name|metadata
operator|=
operator|new
name|Metadata
argument_list|()
expr_stmt|;
if|if
condition|(
name|serverMode
condition|)
block|{
operator|new
name|TikaServer
argument_list|(
name|Integer
operator|.
name|parseInt
argument_list|(
name|arg
argument_list|)
argument_list|)
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|arg
operator|.
name|equals
argument_list|(
literal|"-"
argument_list|)
condition|)
block|{
name|InputStream
name|stream
init|=
name|TikaInputStream
operator|.
name|get
argument_list|(
operator|new
name|CloseShieldInputStream
argument_list|(
name|System
operator|.
name|in
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|type
operator|.
name|process
argument_list|(
name|stream
argument_list|,
name|System
operator|.
name|out
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|stream
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|URL
name|url
decl_stmt|;
name|File
name|file
init|=
operator|new
name|File
argument_list|(
name|arg
argument_list|)
decl_stmt|;
if|if
condition|(
name|file
operator|.
name|isFile
argument_list|()
condition|)
block|{
name|url
operator|=
name|file
operator|.
name|toURI
argument_list|()
operator|.
name|toURL
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|url
operator|=
operator|new
name|URL
argument_list|(
name|arg
argument_list|)
expr_stmt|;
block|}
name|InputStream
name|input
init|=
name|TikaInputStream
operator|.
name|get
argument_list|(
name|url
argument_list|,
name|metadata
argument_list|)
decl_stmt|;
try|try
block|{
name|type
operator|.
name|process
argument_list|(
name|input
argument_list|,
name|System
operator|.
name|out
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|input
operator|.
name|close
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
specifier|private
name|void
name|usage
parameter_list|()
block|{
name|PrintStream
name|out
init|=
name|System
operator|.
name|out
decl_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"usage: java -jar tika-app.jar [option...] [file|port...]"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Options:"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -?  or --help        Print this usage message"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -v  or --verbose     Print debug level messages"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -g  or --gui         Start the Apache Tika GUI"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -s  or --server      Start the Apache Tika server"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -x  or --xml         Output XHTML content (default)"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -h  or --html        Output HTML content"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -j  or --json        Output JSON content"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -t  or --text        Output plain text content"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -T  or --text-main   Output plain text content (main content only)"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -m  or --metadata    Output only metadata"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -l  or --language    Output only language"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -d  or --detect      Detect document type"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -eX or --encoding=X  Use output encoding X"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    -z  or --extract     Extract all attachements into current directory"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    --create-profile=X"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"         Create NGram profile, where X is a profile name"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    --list-parsers"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"         List the available document parsers"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    --list-parser-details"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"         List the available document parsers, and their supported mime types"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    --list-met-models"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"         List the available metadata models, and their supported keys"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    --list-supported-types"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"         List all known media types and related information"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"Description:"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    Apache Tika will parse the file(s) specified on the"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    command line and output the extracted text content"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    or metadata to standard output."
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    Instead of a file name you can also specify the URL"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    of a document to be parsed."
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    If no file name or URL is specified (or the special"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    name \"-\" is used), then the standard input stream"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    is parsed. If no arguments were given and no input"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    data is available, the GUI is started instead."
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"- GUI mode"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    Use the \"--gui\" (or \"-g\") option to start the"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    Apache Tika GUI. You can drag and drop files from"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    a normal file explorer to the GUI window to extract"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    text content and metadata from the files."
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"- Server mode"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    Use the \"-server\" (or \"-s\") option to start the"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    Apache Tika server. The server will listen to the"
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|(
literal|"    ports you specify as one or more arguments."
argument_list|)
expr_stmt|;
name|out
operator|.
name|println
argument_list|()
expr_stmt|;
block|}
specifier|private
name|void
name|displayMetModels
parameter_list|()
block|{
name|Class
argument_list|<
name|?
argument_list|>
index|[]
name|modelClasses
init|=
name|Metadata
operator|.
name|class
operator|.
name|getInterfaces
argument_list|()
decl_stmt|;
name|Arrays
operator|.
name|sort
argument_list|(
name|modelClasses
argument_list|,
operator|new
name|Comparator
argument_list|<
name|Class
argument_list|<
name|?
argument_list|>
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|Class
argument_list|<
name|?
argument_list|>
name|o1
parameter_list|,
name|Class
argument_list|<
name|?
argument_list|>
name|o2
parameter_list|)
block|{
return|return
name|o1
operator|.
name|getName
argument_list|()
operator|.
name|compareTo
argument_list|(
name|o2
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
block|}
block|)
function|;
for|for
control|(
name|Class
argument_list|<
name|?
argument_list|>
name|modelClass
range|:
name|modelClasses
control|)
block|{
comment|// we don't care about internal Tika met classes
comment|// if we do, then we can take this conditional out
if|if
condition|(
operator|!
name|modelClass
operator|.
name|getSimpleName
argument_list|()
operator|.
name|contains
argument_list|(
literal|"Tika"
argument_list|)
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|modelClass
operator|.
name|getSimpleName
argument_list|()
argument_list|)
expr_stmt|;
name|Field
index|[]
name|keyFields
init|=
name|modelClass
operator|.
name|getFields
argument_list|()
decl_stmt|;
name|Arrays
operator|.
name|sort
argument_list|(
name|keyFields
argument_list|,
operator|new
name|Comparator
argument_list|<
name|Field
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|Field
name|o1
parameter_list|,
name|Field
name|o2
parameter_list|)
block|{
return|return
name|o1
operator|.
name|getName
argument_list|()
operator|.
name|compareTo
argument_list|(
name|o2
operator|.
name|getName
argument_list|()
argument_list|)
return|;
block|}
block|}
argument_list|)
expr_stmt|;
for|for
control|(
name|Field
name|keyField
range|:
name|keyFields
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|" "
operator|+
name|keyField
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_class

begin_comment
comment|/*      * Displays loaded parsers and their mime types      * If a parser is a composite parser, it will list the      * sub parsers and their mime-types.      */
end_comment

begin_function
specifier|private
name|void
name|displayParsers
parameter_list|(
name|boolean
name|includeMimeTypes
parameter_list|)
block|{
name|displayParser
argument_list|(
name|parser
argument_list|,
name|includeMimeTypes
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|private
name|void
name|displayParser
parameter_list|(
name|Parser
name|p
parameter_list|,
name|boolean
name|includeMimeTypes
parameter_list|,
name|int
name|i
parameter_list|)
block|{
name|boolean
name|isComposite
init|=
operator|(
name|p
operator|instanceof
name|CompositeParser
operator|)
decl_stmt|;
name|String
name|name
init|=
operator|(
name|p
operator|instanceof
name|ParserDecorator
operator|)
condition|?
operator|(
operator|(
name|ParserDecorator
operator|)
name|p
operator|)
operator|.
name|getWrappedParser
argument_list|()
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
else|:
name|p
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
decl_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|indent
argument_list|(
name|i
argument_list|)
operator|+
name|name
operator|+
operator|(
name|isComposite
condition|?
literal|" (Composite Parser):"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|includeMimeTypes
operator|&&
operator|!
name|isComposite
condition|)
block|{
for|for
control|(
name|MediaType
name|mt
range|:
name|p
operator|.
name|getSupportedTypes
argument_list|(
name|context
argument_list|)
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|indent
argument_list|(
name|i
operator|+
literal|2
argument_list|)
operator|+
name|mt
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|isComposite
condition|)
block|{
name|Parser
index|[]
name|subParsers
init|=
name|sortParsers
argument_list|(
name|invertMediaTypeMap
argument_list|(
operator|(
operator|(
name|CompositeParser
operator|)
name|p
operator|)
operator|.
name|getParsers
argument_list|()
argument_list|)
argument_list|)
decl_stmt|;
for|for
control|(
name|Parser
name|sp
range|:
name|subParsers
control|)
block|{
name|displayParser
argument_list|(
name|sp
argument_list|,
name|includeMimeTypes
argument_list|,
name|i
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|private
name|String
name|indent
parameter_list|(
name|int
name|indent
parameter_list|)
block|{
return|return
literal|"                     "
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|indent
argument_list|)
return|;
block|}
end_function

begin_function
specifier|private
name|Parser
index|[]
name|sortParsers
parameter_list|(
name|Map
argument_list|<
name|Parser
argument_list|,
name|Set
argument_list|<
name|MediaType
argument_list|>
argument_list|>
name|parsers
parameter_list|)
block|{
comment|// Get a nicely sorted list of the parsers
name|Parser
index|[]
name|sortedParsers
init|=
name|parsers
operator|.
name|keySet
argument_list|()
operator|.
name|toArray
argument_list|(
operator|new
name|Parser
index|[
name|parsers
operator|.
name|size
argument_list|()
index|]
argument_list|)
decl_stmt|;
name|Arrays
operator|.
name|sort
argument_list|(
name|sortedParsers
argument_list|,
operator|new
name|Comparator
argument_list|<
name|Parser
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|Parser
name|p1
parameter_list|,
name|Parser
name|p2
parameter_list|)
block|{
name|String
name|name1
init|=
name|p1
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
decl_stmt|;
name|String
name|name2
init|=
name|p2
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
decl_stmt|;
return|return
name|name1
operator|.
name|compareTo
argument_list|(
name|name2
argument_list|)
return|;
block|}
block|}
argument_list|)
expr_stmt|;
return|return
name|sortedParsers
return|;
block|}
end_function

begin_function
specifier|private
name|Map
argument_list|<
name|Parser
argument_list|,
name|Set
argument_list|<
name|MediaType
argument_list|>
argument_list|>
name|invertMediaTypeMap
parameter_list|(
name|Map
argument_list|<
name|MediaType
argument_list|,
name|Parser
argument_list|>
name|supported
parameter_list|)
block|{
name|Map
argument_list|<
name|Parser
argument_list|,
name|Set
argument_list|<
name|MediaType
argument_list|>
argument_list|>
name|parsers
init|=
operator|new
name|HashMap
argument_list|<
name|Parser
argument_list|,
name|Set
argument_list|<
name|MediaType
argument_list|>
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Entry
argument_list|<
name|MediaType
argument_list|,
name|Parser
argument_list|>
name|e
range|:
name|supported
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
operator|!
name|parsers
operator|.
name|containsKey
argument_list|(
name|e
operator|.
name|getValue
argument_list|()
argument_list|)
condition|)
block|{
name|parsers
operator|.
name|put
argument_list|(
name|e
operator|.
name|getValue
argument_list|()
argument_list|,
operator|new
name|HashSet
argument_list|<
name|MediaType
argument_list|>
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|parsers
operator|.
name|get
argument_list|(
name|e
operator|.
name|getValue
argument_list|()
argument_list|)
operator|.
name|add
argument_list|(
name|e
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|parsers
return|;
block|}
end_function

begin_comment
comment|/**      * Prints all the known media types, aliases and matching parser classes.      */
end_comment

begin_function
specifier|private
name|void
name|displaySupportedTypes
parameter_list|()
block|{
name|AutoDetectParser
name|parser
init|=
operator|new
name|AutoDetectParser
argument_list|()
decl_stmt|;
name|MediaTypeRegistry
name|registry
init|=
name|parser
operator|.
name|getMediaTypeRegistry
argument_list|()
decl_stmt|;
name|Map
argument_list|<
name|MediaType
argument_list|,
name|Parser
argument_list|>
name|parsers
init|=
name|parser
operator|.
name|getParsers
argument_list|()
decl_stmt|;
for|for
control|(
name|MediaType
name|type
range|:
name|registry
operator|.
name|getTypes
argument_list|()
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
name|type
argument_list|)
expr_stmt|;
for|for
control|(
name|MediaType
name|alias
range|:
name|registry
operator|.
name|getAliases
argument_list|(
name|type
argument_list|)
control|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"  alias:     "
operator|+
name|alias
argument_list|)
expr_stmt|;
block|}
name|MediaType
name|supertype
init|=
name|registry
operator|.
name|getSupertype
argument_list|(
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
name|supertype
operator|!=
literal|null
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"  supertype: "
operator|+
name|supertype
argument_list|)
expr_stmt|;
block|}
name|Parser
name|p
init|=
name|parsers
operator|.
name|get
argument_list|(
name|type
argument_list|)
decl_stmt|;
if|if
condition|(
name|p
operator|!=
literal|null
condition|)
block|{
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"  parser:    "
operator|+
name|p
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**      * Returns a output writer with the given encoding.      *      * @see<a href="https://issues.apache.org/jira/browse/TIKA-277">TIKA-277</a>      * @param output output stream      * @param encoding output encoding,      *                 or<code>null</code> for the platform default      * @return output writer      * @throws UnsupportedEncodingException      *         if the given encoding is not supported      */
end_comment

begin_function
specifier|private
specifier|static
name|Writer
name|getOutputWriter
parameter_list|(
name|OutputStream
name|output
parameter_list|,
name|String
name|encoding
parameter_list|)
throws|throws
name|UnsupportedEncodingException
block|{
if|if
condition|(
name|encoding
operator|!=
literal|null
condition|)
block|{
return|return
operator|new
name|OutputStreamWriter
argument_list|(
name|output
argument_list|,
name|encoding
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"os.name"
argument_list|)
operator|.
name|toLowerCase
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"mac os x"
argument_list|)
condition|)
block|{
comment|// TIKA-324: Override the default encoding on Mac OS X
return|return
operator|new
name|OutputStreamWriter
argument_list|(
name|output
argument_list|,
literal|"UTF-8"
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|new
name|OutputStreamWriter
argument_list|(
name|output
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/**      * Returns a transformer handler that serializes incoming SAX events      * to XHTML or HTML (depending the given method) using the given output      * encoding.      *      * @see<a href="https://issues.apache.org/jira/browse/TIKA-277">TIKA-277</a>      * @param output output stream      * @param method "xml" or "html"      * @param encoding output encoding,      *                 or<code>null</code> for the platform default      * @return {@link System#out} transformer handler      * @throws TransformerConfigurationException      *         if the transformer can not be created      */
end_comment

begin_function
specifier|private
specifier|static
name|TransformerHandler
name|getTransformerHandler
parameter_list|(
name|OutputStream
name|output
parameter_list|,
name|String
name|method
parameter_list|,
name|String
name|encoding
parameter_list|)
throws|throws
name|TransformerConfigurationException
block|{
name|SAXTransformerFactory
name|factory
init|=
operator|(
name|SAXTransformerFactory
operator|)
name|SAXTransformerFactory
operator|.
name|newInstance
argument_list|()
decl_stmt|;
name|TransformerHandler
name|handler
init|=
name|factory
operator|.
name|newTransformerHandler
argument_list|()
decl_stmt|;
name|handler
operator|.
name|getTransformer
argument_list|()
operator|.
name|setOutputProperty
argument_list|(
name|OutputKeys
operator|.
name|METHOD
argument_list|,
name|method
argument_list|)
expr_stmt|;
name|handler
operator|.
name|getTransformer
argument_list|()
operator|.
name|setOutputProperty
argument_list|(
name|OutputKeys
operator|.
name|INDENT
argument_list|,
literal|"yes"
argument_list|)
expr_stmt|;
if|if
condition|(
name|encoding
operator|!=
literal|null
condition|)
block|{
name|handler
operator|.
name|getTransformer
argument_list|()
operator|.
name|setOutputProperty
argument_list|(
name|OutputKeys
operator|.
name|ENCODING
argument_list|,
name|encoding
argument_list|)
expr_stmt|;
block|}
name|handler
operator|.
name|setResult
argument_list|(
operator|new
name|StreamResult
argument_list|(
name|output
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|handler
return|;
block|}
end_function

begin_class
specifier|private
specifier|static
class|class
name|FileEmbeddedDocumentExtractor
implements|implements
name|EmbeddedDocumentExtractor
block|{
specifier|private
name|int
name|count
init|=
literal|0
decl_stmt|;
specifier|private
specifier|final
name|TikaConfig
name|config
init|=
name|TikaConfig
operator|.
name|getDefaultConfig
argument_list|()
decl_stmt|;
specifier|public
name|boolean
name|shouldParseEmbedded
parameter_list|(
name|Metadata
name|metadata
parameter_list|)
block|{
return|return
literal|true
return|;
block|}
specifier|public
name|void
name|parseEmbedded
parameter_list|(
name|InputStream
name|inputStream
parameter_list|,
name|ContentHandler
name|contentHandler
parameter_list|,
name|Metadata
name|metadata
parameter_list|,
name|boolean
name|outputHtml
parameter_list|)
throws|throws
name|SAXException
throws|,
name|IOException
block|{
name|String
name|name
init|=
name|metadata
operator|.
name|get
argument_list|(
name|Metadata
operator|.
name|RESOURCE_NAME_KEY
argument_list|)
decl_stmt|;
if|if
condition|(
name|name
operator|==
literal|null
condition|)
block|{
name|name
operator|=
name|Integer
operator|.
name|toString
argument_list|(
name|count
argument_list|)
expr_stmt|;
block|}
name|String
name|contentType
init|=
name|metadata
operator|.
name|get
argument_list|(
name|Metadata
operator|.
name|CONTENT_TYPE
argument_list|)
decl_stmt|;
if|if
condition|(
name|name
operator|.
name|indexOf
argument_list|(
literal|'.'
argument_list|)
operator|==
operator|-
literal|1
operator|&&
name|contentType
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|name
operator|+=
name|config
operator|.
name|getMimeRepository
argument_list|()
operator|.
name|forName
argument_list|(
name|contentType
argument_list|)
operator|.
name|getExtension
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|MimeTypeException
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
name|File
name|outputFile
init|=
operator|new
name|File
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|outputFile
operator|.
name|exists
argument_list|()
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"File '"
operator|+
name|name
operator|+
literal|"' already exists; skipping"
argument_list|)
expr_stmt|;
return|return;
block|}
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"Extracting '"
operator|+
name|name
operator|+
literal|"' ("
operator|+
name|contentType
operator|+
literal|")"
argument_list|)
expr_stmt|;
name|FileOutputStream
name|os
init|=
operator|new
name|FileOutputStream
argument_list|(
name|outputFile
argument_list|)
decl_stmt|;
name|IOUtils
operator|.
name|copy
argument_list|(
name|inputStream
argument_list|,
name|os
argument_list|)
expr_stmt|;
name|os
operator|.
name|close
argument_list|()
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
block|}
end_class

begin_class
specifier|private
class|class
name|TikaServer
extends|extends
name|Thread
block|{
specifier|private
specifier|final
name|ServerSocket
name|server
decl_stmt|;
specifier|public
name|TikaServer
parameter_list|(
name|int
name|port
parameter_list|)
throws|throws
name|IOException
block|{
name|super
argument_list|(
literal|"Tika server at port "
operator|+
name|port
argument_list|)
expr_stmt|;
name|server
operator|=
operator|new
name|ServerSocket
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
try|try
block|{
while|while
condition|(
literal|true
condition|)
block|{
name|processSocketInBackground
argument_list|(
name|server
operator|.
name|accept
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|server
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|processSocketInBackground
parameter_list|(
specifier|final
name|Socket
name|socket
parameter_list|)
block|{
name|Thread
name|thread
init|=
operator|new
name|Thread
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
try|try
block|{
name|OutputStream
name|output
init|=
name|socket
operator|.
name|getOutputStream
argument_list|()
decl_stmt|;
name|type
operator|.
name|process
argument_list|(
name|socket
operator|.
name|getInputStream
argument_list|()
argument_list|,
name|output
argument_list|)
expr_stmt|;
name|output
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
finally|finally
block|{
name|socket
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|e
operator|.
name|printStackTrace
argument_list|()
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
name|thread
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|thread
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
block|}
end_class

begin_class
specifier|private
class|class
name|NoDocumentMetHandler
extends|extends
name|DefaultHandler
block|{
specifier|protected
name|PrintWriter
name|writer
decl_stmt|;
specifier|private
name|boolean
name|metOutput
decl_stmt|;
specifier|public
name|NoDocumentMetHandler
parameter_list|(
name|PrintWriter
name|writer
parameter_list|)
block|{
name|this
operator|.
name|writer
operator|=
name|writer
expr_stmt|;
name|this
operator|.
name|metOutput
operator|=
literal|false
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|endDocument
parameter_list|()
block|{
name|String
index|[]
name|names
init|=
name|metadata
operator|.
name|names
argument_list|()
decl_stmt|;
name|Arrays
operator|.
name|sort
argument_list|(
name|names
argument_list|)
expr_stmt|;
name|outputMetadata
argument_list|(
name|names
argument_list|)
expr_stmt|;
name|writer
operator|.
name|flush
argument_list|()
expr_stmt|;
name|this
operator|.
name|metOutput
operator|=
literal|true
expr_stmt|;
block|}
specifier|public
name|void
name|outputMetadata
parameter_list|(
name|String
index|[]
name|names
parameter_list|)
block|{
for|for
control|(
name|String
name|name
range|:
name|names
control|)
block|{
name|writer
operator|.
name|println
argument_list|(
name|name
operator|+
literal|": "
operator|+
name|metadata
operator|.
name|get
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|boolean
name|metOutput
parameter_list|()
block|{
return|return
name|this
operator|.
name|metOutput
return|;
block|}
block|}
end_class

begin_comment
comment|/**      * Uses GSON to do the JSON escaping, but does      *  the general JSON glueing ourselves.      */
end_comment

begin_class
specifier|private
class|class
name|NoDocumentJSONMetHandler
extends|extends
name|NoDocumentMetHandler
block|{
specifier|private
name|NumberFormat
name|formatter
decl_stmt|;
specifier|private
name|Gson
name|gson
decl_stmt|;
specifier|public
name|NoDocumentJSONMetHandler
parameter_list|(
name|PrintWriter
name|writer
parameter_list|)
block|{
name|super
argument_list|(
name|writer
argument_list|)
expr_stmt|;
name|formatter
operator|=
name|NumberFormat
operator|.
name|getInstance
argument_list|()
expr_stmt|;
name|gson
operator|=
operator|new
name|Gson
argument_list|()
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|outputMetadata
parameter_list|(
name|String
index|[]
name|names
parameter_list|)
block|{
name|writer
operator|.
name|print
argument_list|(
literal|"{ "
argument_list|)
expr_stmt|;
name|boolean
name|first
init|=
literal|true
decl_stmt|;
for|for
control|(
name|String
name|name
range|:
name|names
control|)
block|{
if|if
condition|(
operator|!
name|first
condition|)
block|{
name|writer
operator|.
name|println
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|first
operator|=
literal|false
expr_stmt|;
block|}
name|gson
operator|.
name|toJson
argument_list|(
name|name
argument_list|,
name|writer
argument_list|)
expr_stmt|;
name|writer
operator|.
name|print
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
name|outputValues
argument_list|(
name|metadata
operator|.
name|getValues
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|writer
operator|.
name|print
argument_list|(
literal|" }"
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|outputValues
parameter_list|(
name|String
index|[]
name|values
parameter_list|)
block|{
if|if
condition|(
name|values
operator|.
name|length
operator|>
literal|1
condition|)
block|{
name|writer
operator|.
name|print
argument_list|(
literal|"["
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|values
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|String
name|value
init|=
name|values
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|writer
operator|.
name|print
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|==
literal|null
operator|||
name|value
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
name|writer
operator|.
name|print
argument_list|(
literal|"null"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Is it a number?
name|ParsePosition
name|pos
init|=
operator|new
name|ParsePosition
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|formatter
operator|.
name|parse
argument_list|(
name|value
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|.
name|length
argument_list|()
operator|==
name|pos
operator|.
name|getIndex
argument_list|()
condition|)
block|{
comment|// It's a number. Remove leading zeros and output
name|value
operator|=
name|value
operator|.
name|replaceFirst
argument_list|(
literal|"^0+(\\d)"
argument_list|,
literal|"$1"
argument_list|)
expr_stmt|;
name|writer
operator|.
name|print
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Not a number, escape it
name|gson
operator|.
name|toJson
argument_list|(
name|value
argument_list|,
name|writer
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|values
operator|.
name|length
operator|>
literal|1
condition|)
block|{
name|writer
operator|.
name|print
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_class

unit|}
end_unit

